{
  "goal": "Eliminate magic strings and use typed core.Ref system throughout dnd5e",
  "branch": "refactor/eliminate-magic-strings",
  "created": "2025-12-01",
  "phases": [
    {
      "id": 1,
      "name": "Break Import Cycle",
      "description": "Move chain types from combat/ to events/chains.go",
      "status": "completed",
      "completed_at": "2025-12-01",
      "tasks": [
        {
          "id": "1.1",
          "description": "Create events/chains.go with stage constants",
          "status": "completed",
          "file": "rulebooks/dnd5e/events/chains.go",
          "test": "go build ./events/..."
        },
        {
          "id": "1.2",
          "description": "Add DamageSourceType and constants to events/chains.go",
          "status": "completed",
          "file": "rulebooks/dnd5e/events/chains.go",
          "test": "go build ./events/..."
        },
        {
          "id": "1.3",
          "description": "Add RerollEvent and DamageComponent structs",
          "status": "completed",
          "file": "rulebooks/dnd5e/events/chains.go",
          "test": "go build ./events/..."
        },
        {
          "id": "1.4",
          "description": "Add AttackChainEvent and DamageChainEvent structs",
          "status": "completed",
          "file": "rulebooks/dnd5e/events/chains.go",
          "test": "go build ./events/..."
        },
        {
          "id": "1.5",
          "description": "Add AttackChain and DamageChain typed topics",
          "status": "completed",
          "file": "rulebooks/dnd5e/events/chains.go",
          "test": "go build ./events/..."
        },
        {
          "id": "1.6",
          "description": "Update combat/attack.go to import from events/",
          "status": "completed",
          "file": "rulebooks/dnd5e/combat/attack.go",
          "test": "go test ./combat/..."
        },
        {
          "id": "1.7",
          "description": "Update conditions/raging.go to import from events/",
          "status": "completed",
          "file": "rulebooks/dnd5e/conditions/raging.go",
          "test": "go build ./conditions/..."
        },
        {
          "id": "1.8",
          "description": "Update conditions/fighting_style.go to import from events/",
          "status": "completed",
          "file": "rulebooks/dnd5e/conditions/fighting_style.go",
          "test": "go build ./conditions/..."
        },
        {
          "id": "1.9",
          "description": "Update conditions/brutal_critical.go to import from events/",
          "status": "completed",
          "file": "rulebooks/dnd5e/conditions/brutal_critical.go",
          "test": "go build ./conditions/..."
        },
        {
          "id": "1.10",
          "description": "Update all condition test files",
          "status": "completed",
          "files": [
            "rulebooks/dnd5e/conditions/raging_test.go",
            "rulebooks/dnd5e/conditions/fighting_style_test.go",
            "rulebooks/dnd5e/conditions/brutal_critical_test.go"
          ],
          "test": "go test ./conditions/..."
        },
        {
          "id": "1.11",
          "description": "Update combat/breakdown_test.go",
          "status": "completed",
          "file": "rulebooks/dnd5e/combat/breakdown_test.go",
          "test": "go test ./combat/..."
        },
        {
          "id": "1.12",
          "description": "Delete combat/stages.go (moved to events/)",
          "status": "completed",
          "file": "rulebooks/dnd5e/combat/stages.go",
          "test": "go build ./... && go test ./..."
        }
      ]
    },
    {
      "id": 2,
      "name": "Audit Magic Strings",
      "description": "Find all Source string fields that should be core.Ref",
      "status": "completed",
      "completed_at": "2025-12-01",
      "tasks": [
        {
          "id": "2.1",
          "description": "Search for 'Source string' fields in conditions/",
          "status": "completed",
          "test": "grep -r 'Source.*string' conditions/"
        },
        {
          "id": "2.2",
          "description": "Search for string fields containing module:type:id patterns",
          "status": "completed",
          "test": "grep -r 'dnd5e:' ."
        },
        {
          "id": "2.3",
          "description": "Document findings in audit.md",
          "status": "completed",
          "file": "docs/design/eliminate-magic-strings/audit.md"
        }
      ]
    },
    {
      "id": 3,
      "name": "Convert to core.Ref",
      "description": "Change Source string to Source core.Ref where appropriate",
      "status": "in_progress",
      "tasks": [
        {
          "id": "3.1",
          "description": "Convert RagingCondition.Source and RagingData.Source to core.Ref",
          "status": "completed",
          "file": "rulebooks/dnd5e/conditions/raging.go",
          "test": "go test ./conditions/..."
        },
        {
          "id": "3.2",
          "description": "Convert UnarmoredDefenseCondition.Source and UnarmoredDefenseData.Source to core.Ref",
          "status": "pending",
          "file": "rulebooks/dnd5e/conditions/unarmored_defense.go",
          "test": "go test ./conditions/..."
        },
        {
          "id": "3.3",
          "description": "Convert ActiveCondition.Source to core.Ref",
          "status": "pending",
          "file": "rulebooks/dnd5e/conditions/types.go",
          "test": "go test ./conditions/..."
        },
        {
          "id": "3.4",
          "description": "Convert ConditionRemovedEvent.ConditionRef to core.Ref",
          "status": "pending",
          "file": "rulebooks/dnd5e/events/events.go",
          "test": "go build ./events/..."
        },
        {
          "id": "3.5",
          "description": "Convert ConditionGrant.Ref, FeatureGrant.Ref, SpellGrant.Ref to core.Ref",
          "status": "pending",
          "file": "rulebooks/dnd5e/classes/grant.go",
          "test": "go test ./classes/..."
        },
        {
          "id": "3.6",
          "description": "Convert ConditionFactoryInput.Ref and SourceRef to core.Ref",
          "status": "pending",
          "file": "rulebooks/dnd5e/conditions/factory.go",
          "test": "go test ./conditions/..."
        },
        {
          "id": "3.7",
          "description": "Convert FeatureFactoryInput.Ref to core.Ref",
          "status": "pending",
          "file": "rulebooks/dnd5e/features/factory.go",
          "test": "go test ./features/..."
        },
        {
          "id": "3.8",
          "description": "Create ref helper functions in dnd5e package",
          "status": "pending",
          "file": "rulebooks/dnd5e/refs.go",
          "test": "go test ./..."
        },
        {
          "id": "3.9",
          "description": "Replace magic string literals with helper functions",
          "status": "pending",
          "test": "go build ./... && go test ./..."
        }
      ]
    },
    {
      "id": 4,
      "name": "Verify Type Constants",
      "description": "Ensure all packages use canonical Type constants",
      "status": "pending",
      "tasks": []
    }
  ],
  "agent_instructions": {
    "wake_up": [
      "pwd",
      "git branch --show-current",
      "git log --oneline -3",
      "cat docs/design/eliminate-magic-strings/progress.json"
    ],
    "before_edit": [
      "Read the file you're about to edit",
      "Understand current state"
    ],
    "after_edit": [
      "Run the test command for that task",
      "If pass: commit with detailed message",
      "Update progress.json status to 'completed'",
      "Commit progress.json update"
    ],
    "on_error": [
      "Do NOT proceed to next task",
      "Update progress.json with error details",
      "Exit and report"
    ]
  }
}
